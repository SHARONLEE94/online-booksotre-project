<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookstore.mapper.UserMapper">

    <!-- 사용자 조회 -->
    <select id="findById" parameterType="string" resultType="com.bookstore.domain.User">
        SELECT 
            user_id, id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at, last_login_at
        FROM users 
        WHERE id = #{id}
    </select>
    
    <select id="findByUserId" parameterType="long" resultType="com.bookstore.domain.User">
        SELECT 
            user_id, id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at, last_login_at
        FROM users 
        WHERE user_id = #{userId}
    </select>
    
    <select id="findByEmail" parameterType="string" resultType="com.bookstore.domain.User">
        SELECT 
            user_id, id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at, last_login_at
        FROM users 
        WHERE email = #{email}
    </select>
    
    <select id="findByOauthProviderAndUid" resultType="com.bookstore.domain.User">
        SELECT 
            user_id, id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at, last_login_at
        FROM users 
        WHERE oauth_provider = #{oauthProvider} AND oauth_provider_uid = #{oauthProviderUid}
    </select>
    
    <!-- 사용자 생성 -->
    <insert id="insertUser" parameterType="com.bookstore.domain.User" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO users (
            id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at
        ) VALUES (
            #{id}, #{password}, #{name}, #{email}, #{phone}, #{address},
            #{oauthProvider}, #{oauthProviderUid}, #{statusCode}, #{roleCode},
            #{createdAt}, #{updatedAt}
        )
    </insert>
    
    <!-- 사용자 수정 -->
    <update id="updateUser" parameterType="com.bookstore.domain.User">
        UPDATE users SET
            name = #{name},
            email = #{email},
            phone = #{phone},
            address = #{address},
            status_code = #{statusCode},
            role_code = #{roleCode},
            updated_at = #{updatedAt}
        WHERE user_id = #{userId}
    </update>
    
    <!-- 사용자 상태 변경 -->
    <update id="updateUserStatus">
        UPDATE users SET
            status_code = #{statusCode},
            updated_at = NOW()
        WHERE user_id = #{userId}
    </update>
    
    <!-- 마지막 로그인 시간 업데이트 -->
    <update id="updateLastLoginAt" parameterType="long">
        UPDATE users SET
            last_login_at = NOW()
        WHERE user_id = #{userId}
    </update>
    
    <!-- ID 중복 확인 -->
    <select id="existsById" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM users WHERE id = #{id}
    </select>
    
    <!-- 이메일 중복 확인 -->
    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM users WHERE email = #{email}
    </select>
    
    <!-- 관리자용 사용자 목록 조회 -->
    <select id="findAllUsers" resultType="com.bookstore.domain.User">
        SELECT 
            user_id, id, password, name, email, phone, address,
            oauth_provider, oauth_provider_uid, status_code, role_code,
            created_at, updated_at, last_login_at
        FROM users 
        ORDER BY created_at DESC
    </select>

</mapper>
